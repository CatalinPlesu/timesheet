services:
  telegram-bot:
    build:
      context: .
      dockerfile: TimeSheet.Presentation.Telegram/Dockerfile
    container_name: timesheet-telegram-bot
    restart: unless-stopped
    volumes:
      - ./data:/app/data
    environment:
      - DOTNET_ENVIRONMENT=Production
      - Database__ConnectionString=Data Source=/app/data/timesheet.db
      - Database__EnableSensitiveDataLogging=false
      - Database__EnableDetailedErrors=false
      - Bot__Token=${BOT_TOKEN}
      - Serilog__WriteTo__2__Name=OpenTelemetry
      - Serilog__WriteTo__2__Args__endpoint=http://openobserve:5080/api/default/logs
      - Serilog__WriteTo__2__Args__protocol=HttpProtobuf
      - Serilog__WriteTo__2__Args__headers__Authorization=Basic cm9vdEBleGFtcGxlLmNvbTpDb21wbGV4cGFzcyMxMjM=
      - Workers__AutoShutdownCheckInterval=${AUTO_SHUTDOWN_CHECK_INTERVAL:-00:03:00}
      - Workers__ForgotShutdownCheckInterval=${FORGOT_SHUTDOWN_CHECK_INTERVAL:-00:03:00}
      - Workers__LunchReminderCheckInterval=${LUNCH_REMINDER_CHECK_INTERVAL:-00:03:00}
      - Workers__WorkHoursAlertCheckInterval=${WORK_HOURS_ALERT_CHECK_INTERVAL:-00:03:00}
    depends_on:
      - openobserve
    networks:
      - timesheet-network

  api:
    build:
      context: .
      dockerfile: TimeSheet.Presentation.API/Dockerfile
    container_name: timesheet-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-5000}:5000"
    volumes:
      - ./data:/app/data
    environment:
      - DOTNET_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - Database__ConnectionString=Data Source=/app/data/timesheet.db
      - Database__EnableSensitiveDataLogging=false
      - Database__EnableDetailedErrors=false
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER:-TimeSheet.API}
      - JwtSettings__Audience=${JWT_AUDIENCE:-TimeSheet.Web}
      - JwtSettings__ExpirationMinutes=${JWT_EXPIRATION_MINUTES:-60}
      - Cors__AllowedOrigins__0=http://localhost:${FRONTEND_PORT:-3000}
      - Cors__AllowedOrigins__1=${FRONTEND_EXTERNAL_URL:-http://localhost:3000}
      - Serilog__WriteTo__2__Name=OpenTelemetry
      - Serilog__WriteTo__2__Args__endpoint=http://openobserve:5080/api/default/logs
      - Serilog__WriteTo__2__Args__protocol=HttpProtobuf
      - Serilog__WriteTo__2__Args__headers__Authorization=Basic cm9vdEBleGFtcGxlLmNvbTpDb21wbGV4cGFzcyMxMjM=
    depends_on:
      - openobserve
    networks:
      - timesheet-network

  frontend:
    image: python:3-slim
    container_name: timesheet-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:8080"
    volumes:
      - ./TimeSheet.Frontend:/app:ro
    working_dir: /app
    command: python3 -m http.server 8080
    networks:
      - timesheet-network

  openobserve:
    image: openobserve/openobserve:latest
    container_name: timesheet-openobserve
    restart: unless-stopped
    ports:
      - "${OPENOBSERVE_PORT:-5080}:5080"
    volumes:
      - openobserve-data:/data
    environment:
      - ZO_ROOT_USER_EMAIL=root@example.com
      - ZO_ROOT_USER_PASSWORD=Complexpass#123
      - ZO_DATA_DIR=/data
    networks:
      - timesheet-network

volumes:
  openobserve-data:
    driver: local

networks:
  timesheet-network:
    driver: bridge
